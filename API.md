# Документация по методам API

- [Вызов методов](#вызов-методов)
- [Ответы](#ответы)
  - [Успешный ответ](#успешный-ответ)
  - [Ответ с ошибкой](#ответ-с-ошибкой)
- [Коды ошибок](#коды-общих-ошибок)

Методы:

- [User](#user)
  - [user.new](#usernew)
  - [user.get](#userget)
- [Quest](#quest)
  - [quest.new](#questnew)
  - [quest.get](#questget)
  - [quest.completeQuest](#questcompletequest)
  - [quest.getCompletedQuests](#questgetcompletedquests)

---

## Вызов методов

Методы вызываются через HTTP при помощи методов GET или POST.

Используется адрес следующего вида:

```
http://<адрес-сервера>/<контроллер>.<метод>?<параметры>
```

Пример вызова метода:

```
http://localhost:8080/user.new?name=test
```

## Ответы

Ответы отдаются в формате JSON. Каждый ответ содержит поле `status`, которое содержит статус ответа.

### Успешный ответ

Если ответ успешен, то API возвращает код HTTP `200 OK`, а поле `status` принимает значение `"success"`.

Результат выполнения метода указан в поле `result`, он может принимать любой поддерживаемый JSON тип данных: 
число, строку, массив или объект.

Пример успешного ответа:

```json
{
  "status": "success",
  "result": {
    "user_id": 1
  }
}
```

### Ответ с ошибкой

Если запрос завершился с ошибкой, то поле `status` принимает значение `"error"`.

Ошибка указана в поле `error`, которое представляет собой объект с полем `code`, содержащим
[числовой код ошибки](#коды-общих-ошибок), и полем `message`, содержащем строку с текстом ошибки.

Пример ответа с ошибкой:

```json
{
  "status": "error",
  "error": {
    "code": 5,
    "message": "Parameter id is too large for 32-bit unsigned int"
  }
}
```

## User

### user.new

Создаёт нового пользователя с указанным именем и нулевым балансом.

#### Параметры

| Параметр | Тип параметра        | Описание параметра | Обязательный |
|----------|----------------------|--------------------|--------------|
| name     | string (length 1-32) | Имя пользователя   | Да           |

#### Результат

Возвращает объект с полем `user_id`, в котором содержится ID только что созданного пользователя.

Пример ответа:

```json
{
  "status": "success",
  "result": {
    "user_id": 1
  }
}
```

#### Коды ошибок

Метод может вернуть ошибку из числа [общих ошибок](#коды-общих-ошибок).

### user.get

Возвращает пользователя с указанным идентификатором.

#### Параметры

| Параметр | Тип параметра       | Описание параметра         | Обязательный |
|----------|---------------------|----------------------------|--------------|
| id       | unsigned int 32-bit | Идентификатор пользователя | Да           |

#### Результат

Возвращает объект `user`, содержащий поля `name` и `balance`.

Пример ответа:

```json
{
  "status": "success",
  "result": {
    "name": "test",
    "balance": 100
  }
}
```

#### Коды ошибок

Метод может вернуть ошибку из числа [общих ошибок](#коды-общих-ошибок).

## Quest

### quest.new

Создаёт новое задание с указанным названием и наградой за выполнение.

#### Параметры

| Параметр | Тип параметра       | Описание параметра    | Обязательный |
|----------|---------------------|-----------------------|--------------|
| id       | unsigned int 32-bit | Идентификатор задания | Да           |
| cost     | unsigned int 32-bit | Награда за выполнение | Да           |

#### Коды ошибок

Метод может вернуть ошибку из числа [общих ошибок](#коды-общих-ошибок).

### quest.get

Возвращает задание с указанным идентификатором.

#### Параметры

| Параметр | Тип параметра       | Описание параметра    | Обязательный |
|----------|---------------------|-----------------------|--------------|
| id       | unsigned int 32-bit | Идентификатор задания | Да           |

#### Результат

Возвращает объект `quest`, содержащий поля `name` и `cost`.

Пример ответа:

```json
{
  "status": "success",
  "result": {
    "name": "test_quest",
    "cost": 100
  }
}
```

#### Коды ошибок

Метод может вернуть ошибку из числа [общих ошибок](#коды-общих-ошибок).

### quest.completeQuest

Оповещает сервис о том, что пользователь выполнил задание.

#### Параметры

| Параметр | Тип параметра       | Описание параметра         | Обязательный |
|----------|---------------------|----------------------------|--------------|
| user_id  | unsigned int 32-bit | Идентификатор пользователя | Да           |
| quest_id | unsigned int 32-bit | Идентификатор задания      | Да           |

#### Результат

Возвращает объект, содержащий поле `quest` с параметрами выполненного задания и поле `user_balance`, содержащее 
актуальный баланс пользователя после выполнения задания.

Пример ответа:

```json
{
  "status": "success",
  "result": {
    "quest": {
      "name": "test_quest",
      "cost": 100
    },
    "user_balance": 200
  }
}
```

#### Коды ошибок

Помимо [общих ошибок](#коды-общих-ошибок)., у данного метода есть следующие коды ошибок:

| Код | Описание ошибки    | Пример возникновения                                  |
|-----|--------------------|-------------------------------------------------------|
| 7   | Квест уже выполнен | Указанный пользователь уже выполнил указанное задание |

### quest.getCompletedQuests

Возвращает список выполненных заданий для указанного пользователя.

#### Параметры

| Параметр | Тип параметра       | Описание параметра                              | Обязательный             |
|----------|---------------------|-------------------------------------------------|--------------------------|
| user_id  | unsigned int 32-bit | Идентификатор пользователя                      | Да                       |
| count    | unsigned int 32-bit | Количество заданий, которое необходимо получить | Нет *(по умолчанию 200)* |
| offset   | unsigned int 32-bit | Смещение в списке выполненных заданий           | Нет *(по умолчанию 0)*   |

#### Результат

Возвращает объект, содержащий поле `balance` с балансом пользователя, поле `count` c общим количеством выполненных 
заданий и полем `items`, представляющим собой список объектов, описывающих выполненные 
задания и содержащих UNIX-время выполнения задания.

Пример ответа:

```json
{
  "status": "success",
  "result": {
    "balance": 200,
    "count": 3,
    "items": [
      {
        "quest": {
          "id": 1,
          "name": "test_quest1",
          "cost": 50
        },
        "completed_at": 1710781887
      },
      {
        "quest": {
          "id": 2,
          "name": "test_quest2",
          "cost": 100
        },
        "completed_at": 1710781865
      },
      {
        "quest": {
          "id": 3,
          "name": "test_quest3",
          "cost": 50
        },
        "completed_at": 1710781820
      }
    ]
  }
}
```

#### Коды ошибок

Метод может вернуть ошибку из числа [общих ошибок](#коды-общих-ошибок).

## Коды общих ошибок

| Код | Описание ошибки                 | Пример возникновения                                                |
|-----|---------------------------------|---------------------------------------------------------------------|
| 1   | Не указан метод                 | Обращение к «корневому каталогу» API                                |
| 2   | Не найден контроллер            | Обращение к несуществующему контроллеру                             |
| 3   | Не найден метод                 | Обращение к несуществующему методу какого-либо контроллера          |
| 4   | Не указан обязательный параметр | Не указан параметр `id` в методе `user.get`                         |
| 5   | Неверный формат параметра       | Параметр `id` задан строкой, когда ожидается целочисленное значение |
| 6   | Модель не найдена               | Не найден пользователь с указанным `id`                             |
| 255 | Внутренняя ошибка сервиса       | Ошибка в файле конфигурации                                         |
